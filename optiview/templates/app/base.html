<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Optiview Goggles</title>
    {% load static %}

    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'app/css/style.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="logo">Optiview</div>

        <nav class="nav-menu d-flex align-items-center gap-3">
            <a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a>
            <a href="/shop/" class="{% if request.path == '/shop/' %}active{% endif %}">Shop</a>
            <a href="/about/" class="{% if request.path == '/about/' %}active{% endif %}">About</a>
            <a href="/contact/" class="{% if request.path == '/contact/' %}active{% endif %}">Contact</a>

            <!-- CART ICON -->
            <a href="/cart/" class="cart-icon position-relative {% if request.path == '/cart/' %}active{% endif %}">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cart-count">{{ cart_count }}</span>
            </a>

            <!-- WISHLIST -->
            <a href="/wishlist/" class="heart-icon {% if request.path == '/wishlist/' %}active{% endif %}">
                <i class="far fa-heart"></i>
            </a>

            <!-- ACCOUNT -->
            <div class="account-dropdown position-relative">
                <span class="account-btn">Account â–¾</span>
                <div class="account-menu position-absolute">
                    {% if user.is_authenticated %}
                        <p>Hi, {{ user.username }}</p>
                        <a href="{% url 'logout' %}">Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}">Login</a>
                        <a href="{% url 'register' %}">Register</a>
                    {% endif %}
                </div>
            </div>
        </nav>
    </div>
</header>

<!-- MESSAGES -->
{% if messages %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;">
  {% for message in messages %}
  <div class="toast align-items-center text-white bg-success border-0 show mb-2">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>
<!-- Notification Bell -->
<div class="notification-wrapper" style="position: relative;">
    <button id="notification-bell">
        ðŸ””
        <span id="notification-count" style="background:red;color:white;border-radius:50%;padding:2px 6px;font-size:12px;">0</span>
    </button>

    <div id="notification-dropdown" style="display:none; position:absolute; right:0; top:30px; background:white; border:1px solid #ccc; width:300px; max-height:400px; overflow:auto; z-index:1000;">
        <div id="notification-items"></div>
    </div>
</div>

<script>
// Toggle dropdown
const bell = document.getElementById("notification-bell");
const dropdown = document.getElementById("notification-dropdown");

bell.addEventListener("click", () => {
    dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
});

// Browser notifications
function sendBrowserNotification(title, message) {
    if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, { body: message });
    }
}

// Fetch notifications from server
async function fetchNotifications() {
    const res = await fetch("{% url 'get_notifications' %}");
    const data = await res.json();

    const countSpan = document.getElementById("notification-count");
    const itemsDiv = document.getElementById("notification-items");

    itemsDiv.innerHTML = ""; // clear dropdown

    if (data.notifications.length === 0) {
        countSpan.textContent = "0";
        itemsDiv.innerHTML = "<p style='padding:10px;'>No new notifications</p>";
    } else {
        countSpan.textContent = data.notifications.length;
        data.notifications.forEach(n => {
            // Add to dropdown
            const div = document.createElement("div");
            div.className = "notification-item";
            div.style.padding = "10px; border-bottom:1px solid #eee; cursor:pointer;";
            div.innerHTML = `<strong>${n.title}</strong><p>${n.message}</p>`;
            div.addEventListener("click", async () => {
                await fetch(`/notifications/mark-as-read/${n.id}/`);
                fetchNotifications(); // refresh
            });
            itemsDiv.appendChild(div);

            // Send browser notification
            sendBrowserNotification(n.title, n.message);
        });
    }
}

// Request permission
document.addEventListener("DOMContentLoaded", () => {
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
    }
    fetchNotifications();
    setInterval(fetchNotifications, 10000); // refresh every 10 sec
});
</script>

<script>
  setTimeout(() => {
    document.querySelectorAll('.toast').forEach(t => t.remove());
  }, 3000);
</script>
{% endif %}



<!-- MAIN CONTENT -->
{% block content %}{% endblock %}

<!-- FOOTER -->
<footer class="figma-footer mt-5">
    <div class="footer-grid container">
        <div class="footer-col">
            <h4>Optiview</h4>
            <p>Premium goggles designed for style, comfort and eye protection.</p>
        </div>
        <div class="footer-col">
            <h4>Quick Links</h4>
            <p><a href="/">Home</a></p>
            <p><a href="/shop/">Shop</a></p>
            <p><a href="/about/">About Us</a></p>
            <p><a href="/contact/">Contact</a></p>
        </div>
        <div class="footer-col">
            <h4>Contact</h4>
            <p>Email: twinseyeoptics@gmail.com</p>
            <p>Phone: +91 8160133978</p>
            <p>Mon - Sun : 9AM - 8PM</p>
        </div>
        <div class="footer-col">
            <h4>Follow Us</h4>
            <p><a href="#"><i class="fab fa-instagram"></i> Instagram</a></p>
            <p><a href="#"><i class="fab fa-facebook"></i> Facebook</a></p>
            <p><a href="#"><i class="fab fa-x-twitter"></i> Twitter</a></p>
        </div>
    </div>
    <div class="footer-brand text-center mt-3">
        <h2>Optiview</h2>
        <p>Â© 2026 Optiview. All rights reserved.</p>
    </div>
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    if ("Notification" in window) {
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    }
});
</script>
<script>
function sendBrowserNotification(title, message) {
    if (Notification.permission === "granted") {
        new Notification(title, {
            body: message,
            icon: "/static/app/images/notification-icon.png", // optional, put your icon
        });
    }
}
</script>
<script>
async function checkNotifications() {
    const res = await fetch("/notifications/");
    const data = await res.json();
    data.notifications.forEach(n => sendBrowserNotification(n.title, n.message));
}

// check every 10 seconds
setInterval(checkNotifications, 10000);
</script>

</body>
</html>
