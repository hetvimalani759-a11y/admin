<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Optiview Goggles</title>
    {% load static %}

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'app/css/style.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="logo">Optiview</div>

        <nav class="nav-menu d-flex align-items-center gap-3">
            <a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a>
            <a href="/shop/" class="{% if request.path == '/shop/' %}active{% endif %}">Shop</a>
            <a href="/about/" class="{% if request.path == '/about/' %}active{% endif %}">About</a>
            <a href="/contact/" class="{% if request.path == '/contact/' %}active{% endif %}">Contact</a>
            <a href="/orders/history/" class="{% if request.path == '/orders/history/' %}active{% endif %}">My Orders</a>
            <!-- ðŸ”” NOTIFICATIONS -->
            {% if user.is_authenticated %}
            <div class="position-relative" id="notif-wrapper" style="display:none;">
                <button id="notif-btn" style="background:none;border:none;font-size:20px;cursor:pointer;">
                    ðŸ”” <span id="notif-count"
                        style="background:red;color:white;border-radius:50%;padding:2px 6px;font-size:12px;display:none;">0</span>
                </button>

                <div id="notif-box"
                    style="display:none;position:absolute;right:0;top:30px;width:300px;background:white;color:#000;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:999;">
                    <div id="notif-items"></div>
                </div>
            </div>
            {% endif %}

            <!-- CART -->
            <a href="/cart/" class="cart-icon position-relative {% if request.path == '/cart/' %}active{% endif %}">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cart-count">{{ cart_count }}</span>
            </a>

            <!-- WISHLIST -->
            <a href="/wishlist/" class="heart-icon {% if request.path == '/wishlist/' %}active{% endif %}">
                <i class="far fa-heart"></i>
            </a>

            <!-- ACCOUNT -->
            <div class="account-dropdown position-relative">
                <span class="account-btn">Account â–¾</span>
                <div class="account-menu position-absolute">
                    {% if user.is_authenticated %}
                        <p>Hi, {{ user.username }}</p>
                        <a href="{% url 'logout' %}">Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}">Login</a>
                        <a href="{% url 'register' %}">Register</a>
                    {% endif %}
                </div>
            </div>
        </nav>
    </div>
</header>

<!-- TOAST MESSAGES -->
{% if messages %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:9999;">
  {% for message in messages %}
  <div class="toast align-items-center text-white bg-success border-0 show mb-2">
    <div class="d-flex">
      <div class="toast-body">{{ message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- MAIN CONTENT -->
{% block content %}{% endblock %}

<!-- FOOTER -->
<footer class="figma-footer mt-5">
    <div class="footer-grid container">
        <div class="footer-col">
            <h4>Optiview</h4>
            <p>Premium goggles designed for style, comfort and eye protection.</p>
        </div>
        <div class="footer-col">
            <h4>Quick Links</h4>
            <p><a href="/">Home</a></p>
            <p><a href="/shop/">Shop</a></p>
            <p><a href="/about/">About Us</a></p>
            <p><a href="/contact/">Contact</a></p>
        </div>
        <div class="footer-col">
            <h4>Contact</h4>
            <p>Email: twinseyeoptics@gmail.com</p>
            <p>Phone: +91 8160133978</p>
            <p>Mon - Sun : 9AM - 8PM</p>
        </div>
        <!-- <div class="footer-col">
            <h4>Follow Us</h4>
            <p><a href="#"><i class="fab fa-instagram"></i> Instagram</a></p>
            <p><a href="#"><i class="fab fa-facebook"></i> Facebook</a></p>
            <p><a href="#"><i class="fab fa-twitter"></i> Twitter</a></p>
        </div> -->
    </div>
    <div class="footer-brand text-center mt-3">
        <h2>Optiview</h2>
        <p>Â© 2026 Optiview. All rights reserved.</p>
    </div>
</footer>

<!-- JS -->
<script src="{% static 'app/js/shop.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


{% if user.is_authenticated %}
<script>
const notifWrapper = document.getElementById("notif-wrapper");
const btn = document.getElementById("notif-btn");
const box = document.getElementById("notif-box");
const countBadge = document.getElementById("notif-count");
const itemsBox = document.getElementById("notif-items");

// Toggle notification box
btn.onclick = () => {
    box.style.display = box.style.display === "none" ? "block" : "none";
};

// Browser notification helper
function showBrowserNotification(title, message) {
    if ("Notification" in window && Notification.permission === "granted") {
        try {
            new Notification(title, { body: message });
        } catch(e) {
            console.log("Notification failed", e);
        }
    }
}

// Load notifications from backend
async function loadNotifications() {
    const res = await fetch("{% url 'get_notifications' %}");
    const data = await res.json();

    if (!data.notifications || data.notifications.length === 0) {
        notifWrapper.style.display = "none"; // hide if no notifications
        return;
    }

    notifWrapper.style.display = "inline-block"; // show notification icon

    countBadge.style.display = "inline";
    countBadge.textContent = data.notifications.length;

    itemsBox.innerHTML = "";
    data.notifications.forEach(n => {
        const div = document.createElement("div");
        div.style.padding = "12px";
        div.style.borderBottom = "1px solid #eee";
        div.style.cursor = "pointer";
        div.innerHTML = `
            <strong style="color:#000">${n.title}</strong>
            <p style="color:#555;margin:0">${n.message}</p>
        `;

        div.onclick = async () => {
            await fetch(`/notifications/read/${n.id}/`);
            loadNotifications();
        };
        itemsBox.appendChild(div);
        showBrowserNotification(n.title, n.message);
    });
}

// Account dropdown toggle
const accountDropdown = document.querySelector(".account-dropdown");
const accountMenu = accountDropdown.querySelector(".account-menu");
accountDropdown.addEventListener("mouseenter", () => { accountMenu.style.display = "block"; });
accountDropdown.addEventListener("mouseleave", () => { accountMenu.style.display = "none"; });

document.addEventListener("DOMContentLoaded", () => {
    if ("Notification" in window && Notification.permission !== "granted") {
        Notification.requestPermission();
    }
    loadNotifications();
    setInterval(loadNotifications, 8000);
});
</script>
{% endif %}

</body>
</html>
