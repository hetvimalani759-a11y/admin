{% extends 'app/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/shop.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
{% endblock %}

{% block content %}
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="container py-4">

    <a href="{% url 'shop' %}" class="btn btn-outline-dark mb-3">‚Üê Back</a>

    <div class="row g-4 align-items-start">

        <!-- Image -->
        <div class="col-md-5 text-center">
            <img src="{{ product.image.url | default:'/static/app/images/default.png' }}"
                 class="img-fluid" alt="{{ product.name }}">
        </div>

        <!-- Info -->
        <div class="col-md-7">

            <div class="product-rating mb-1">
                <span class="rating">{{ product.rating|default:4.5 }} ‚òÖ</span>
                <span class="reviews">({{ product.review_count|default:100 }})</span>
            </div>

            <div class="product-brand">{{ product.brand|default:"Brand Name" }}</div>
            <h3 class="product-name">{{ product.name }}</h3>

            <div class="price-row mb-3">
                {% if product.get_offer %}
                    <span class="discounted-price">‚Çπ{{ product.get_final_price|floatformat:0 }}</span>
                    <span class="original-price">‚Çπ{{ product.price|floatformat:0 }}</span>
                    <span class="discount-percentage">({{ product.get_offer.discount_value }}% OFF)</span>
                {% else %}
                    <span class="discounted-price">‚Çπ{{ product.price|floatformat:0 }}</span>
                {% endif %}
            </div>

            <p class="mb-2">{{ product.description|default:"No description available." }}</p>

            <p><strong>Category:</strong> {{ product.category }}</p>
            <p><strong>Sub-Category:</strong> {{ product.subcategory|default:"-" }}</p>

            <div class="d-flex gap-2 mt-3">
                {% if product.stock > 0 %}
                    <button class="btn btn-primary btn-sm add-to-cart-btn" data-id="{{ product.id }}">
                        üõí Add to Cart
                    </button>
                {% else %}
                    <button class="btn btn-secondary btn-sm" disabled>Out of Stock</button>
                {% endif %}

                <button class="btn btn-sm toggle-wishlist-btn" data-id="{{ product.id }}">
                    {% if product.id in wishlist_ids %}
                        <i class="fa-solid fa-heart"></i>
                    {% else %}
                        <i class="fa-regular fa-heart"></i>
                    {% endif %}
                </button>
            </div>

        </div>
    </div>

</div>
<script>
document.addEventListener("DOMContentLoaded", () => {

    const csrfToken = document.getElementById("csrf-token").value;

    document.querySelectorAll(".toggle-wishlist-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const productId = btn.dataset.id;
            const icon = btn.querySelector("i");

            try {
                const res = await fetch("/wishlist/toggle/", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ product_id: productId })
                });

                const data = await res.json();

                if (data.in_wishlist) {
                    icon.classList.remove("fa-regular");
                    icon.classList.add("fa-solid");
                    icon.style.color = "red";
                } else {
                    icon.classList.remove("fa-solid");
                    icon.classList.add("fa-regular");
                    icon.style.color = "";
                }
            } catch (err) {
                console.error(err);
            }
        });
    });

});
</script>

{% endblock %}
