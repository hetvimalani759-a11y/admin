{% extends "app/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/checkout.css' %}">
{% endblock %}

{% block content %}
<form method="POST" action="{% url 'checkout' %}" class="checkout-page" id="checkoutForm">
{% csrf_token %}

<!-- ===== STEP 1 ===== -->
<div class="checkout-section">
  <div class="section-header">1. Delivery Address</div>

  <div class="address-box" id="addressBox">

    <div class="form-row">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" name="full_name" id="full_name" value="{{ request.user.first_name }}">
      </div>

      <div class="form-group">
        <label>Mobile Number</label>
        <div class="phone-row">
          <select disabled><option>+91</option></select>
          <input type="text" name="phone" id="phone" maxlength="10">
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Address</label>
      <input type="text" name="address" id="address">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>State</label>
        <select name="state" id="state">
          <option value="">Select State</option>
          <option>Gujarat</option>
          <option>Maharashtra</option>
          <option>Delhi</option>
          <option>Karnataka</option>
          <option>Rajasthan</option>
        </select>
      </div>

      <div class="form-group">
        <label>City</label>
        <select name="city" id="city">
          <option value="">Select City</option>
        </select>
      </div>

      <div class="form-group">
        <label>Pincode</label>
        <input type="text" name="pincode" id="pincode" maxlength="6">
      </div>
    </div>

    <button type="button" id="saveAddressBtn">Save Address</button>
    <button type="button" id="editAddressBtn" class="hidden">Edit Address</button>
  </div>
  <div class="address-preview hidden" id="addressPreview" data-has-address="{{ has_address|yesno:'1,0' }}"></div>

</div>

<!-- ===== STEP 2 ===== -->
<div class="checkout-section disabled" id="paymentSection">
  <div class="section-header">2. Payment Method</div>
  <div class="payment-box">
    <label><input type="radio" name="payment" value="COD" checked> Cash on Delivery</label>
    <label><input type="radio" name="payment" value="ONLINE"> Online Payment</label>
  </div>
</div>

<!-- ===== STEP 3 ===== -->
<div class="checkout-section disabled" id="reviewSection">
  <div class="section-header">3. Review Items</div>
  <div class="items-box">

    {% for item in cart_items %}
    <div class="checkout-item"
         data-id="{{ item.id }}"
         data-original="{{ item.product.price }}"
         data-final="{{ item.product.get_final_price }}">

      <img src="{{ item.product.image.url }}">

      <div class="item-info">
        <div class="item-name">{{ item.product.name }}</div>

        <div class="item-price">
          {% with offer=item.product.get_offer %}
            {% if offer %}
              <strong class="final-price">₹{{ item.product.get_final_price|floatformat:0 }}</strong>
              <span class="original-price">₹{{ item.product.price|floatformat:0 }}</span>
              {% if offer.discount_type == "percent" %}
                <span class="discount-text">({{ offer.discount_value }}% OFF)</span>
              {% else %}
                <span class="discount-text">(₹{{ offer.discount_value }} OFF)</span>
              {% endif %}
            {% else %}
              <strong class="final-price">₹{{ item.product.price|floatformat:0 }}</strong>
            {% endif %}
          {% endwith %}
        </div>
      </div>

      <!-- Quantity -->
      <div class="qty-controls">
        <button type="button" class="qty-btn minus-btn">−</button>
        <span class="qty-number">{{ item.quantity }}</span>
        <button type="button" class="qty-btn plus-btn">+</button>
      </div>



      <!-- ✅ ONLY CHANGE -->
      <a href="#" class="remove-btn" data-remove-url="{% url 'remove_from_cart' item.id %}">Remove</a>
    </div>
    {% endfor %}

  </div>
</div>

<!-- ===== SUMMARY ===== -->
<div class="order-summary">
  <h3>Order Summary</h3>

  <div class="summary-row">
    <span>Items</span>
    <span id="summaryItems">{{ cart_items|length }}</span>
  </div>

  <div class="summary-row">
    <span>Original Total</span>
    <span>₹<span id="summaryOriginal">0</span></span>
  </div>

  <div class="summary-row">
    <span>Offer Discount</span>
    <span style="color:green;">− ₹<span id="summaryDiscount">0</span></span>
  </div>

  <div class="summary-row">
    <span>Delivery</span>
    <span>₹<span id="summaryDelivery">{{ delivery }}</span></span>
  </div>

  <hr>
  <div class="saved-banner" id="saved-banner" style="display:none;"></div>
  <div class="summary-row summary-total">
    <span>Total Payable</span>
    <span>₹<span id="summaryTotal">0</span></span>
  </div>

  <br>
  <button type="submit" id="placeOrderBtn" class="place-order-btn" disabled>Place Order</button>
  <div class="summary-actions">
    <a href="{% url 'shop' %}" class="add-more-link" style="text-align: center;">➕ Add More Items</a>
  </div>
</div>

</form>

<!-- ✅ MODAL (unchanged) -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal-box">
    <p id="confirm-text">Are you sure?</p>
    <div class="modal-actions">
      <button id="confirm-yes" class="modal-confirm">Yes</button>
      <button id="confirm-no" class="modal-cancel">No</button>
    </div>
  </div>
</div>

{% block extra_js %}
<script src="{% static 'app/js/checkout.js' %}"></script>
{% endblock %}

{% endblock %}
